@using System.Configuration.Internal
@using Humanizer
@using Org.BouncyCastle.Crypto.Engines
@model Cart

@{
    ViewBag.Title = "Giỏ Hàng";
    Layout = "_SecondaryLayout";
    var sellerGroupBy = Model.CartItems.GroupBy(c => c.TypeProduct!.Product!.SellerId);
    var totalPrice = Model.CartItems.Sum(c => c.Quantity * c.TypeProduct!.Product!.Price);
}

@section Styles
{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" asp-append-version="true">
    <link rel="stylesheet" href="~/css/actions/StyleCart.css" asp-append-version="true">
}

@section Scripts
{
    <script src="~/js/Actions/JsCart.js" asp-append-version="true"></script>
    <script src="~/js/partials/product_list.js" asp-append-version="true"></script>

}

@section HeaderNav {
    <div class="bg-white">
        <div class="d-flex cart-header container-md">
            <div class="header">
                <div class="navbar-brand">
                    <a asp-controller="Home" asp-action="Index" class="h-100 text-center align-items-center d-flex align-items-center text-decoration-none">
                        <img class="logo" src="/imgs/shopping-brand.png" alt="logo-brand">
                        <h2 class="m-0 pt-2 fw-normal">Aetherix</h2>
                        <div class="divider"></div>
                        <div class="cart1">Giỏ hàng</div>
                    </a>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Tìm sản phẩm">
                <button id="search-button" onclick="Erorr()">
                    <i class="fa-solid fa-magnifying-glass fa-beat" id="icon-search"></i>
                </button>
            </div>
        </div>
    </div>
}

<section class="header-top">
<div class="container1">
<div class="header1">
    <img src="/imgs/freeship.png" alt=""> Nhấn vào mục Mã giảm giá ở cuối trang để hưởng miễn phí vận chuyển bạn nhé!
</div>
<table>
    <thead>
    <tr>
        <th>
            <div id="selectAllProducts">
                <input type="checkbox" id="selectAllCheckbox"> Tất Cả Sản phẩm
            </div>
        </th>
        <th class="op-50">Đơn giá</th>
        <th class="op-50">Số lượng</th>
        <th class="op-50">Số tiền</th>
        <th class="op-50">Thao tác</th>
    </tr>
    </thead>
    @if (Model.CartItems.Count != 0)  
    {
        <tbody>

        @foreach (var cartItems in sellerGroupBy)
        {
            var listCartItem = cartItems.ToList();
            var seller = listCartItem[0].TypeProduct!.Product!.Seller;
            <tr>
                <td colspan="5" class="checkbox-tenshop" onclick="Erorr()">
                    <div class="tenshop">
                        <img src="/imgs/logomall.png">
                        <div>@seller!.SellerName</div>
                        <i class="fa-regular fa-message"></i>
                    </div>
                </td>
            </tr>
            @foreach (var cartItem in listCartItem)
            {
                decimal total = (decimal)cartItem.Quantity * (decimal)cartItem.TypeProduct.Product.Price.Value;
                <tr class="product-item">
                    <input id="cartItemId" type="hidden" value="@cartItem.Id"/>
                    <td class="o-sanpham">
                        <div class="o-sanpham1">
                            <input type="checkbox" class="product-checkbox" style="margin-right: 5px;">
                            <a asp-controller="Detail" asp-action="Index" asp-route-id="@cartItem.TypeProduct.Product.Id">
                                <div class="image" style="margin-right: 10px;!important;">
                                    <img src="@cartItem.TypeProduct!.ImagePath" class="img-sanpham"/>
                                </div>
                            </a>
                            <div class="ten-sanpham">
                                @cartItem.TypeProduct.Product.ProductName
                                <div>
                                    <img class="logo-sale" src="~/imgs/sale11.11.png">
                                </div>
                                <div class="mienphi-trahang"><img src="~/imgs/logoduoisale10.10.png"> 7 Ngày Miễn Phí Trả Hàng</div>
                            </div>
                            <div class="phanloai">
                                <div>Phân loại hàng:</div>
                                <select id="loaimau" name="loaimau">

                                    @foreach (var productTypeProduct in cartItem.TypeProduct.Product.TypeProducts)
                                    {
                                        if (cartItem.TypeProductId != productTypeProduct.Id)
                                        {
                                            <option value="@productTypeProduct.Id"> @productTypeProduct.TypeName </option>
                                        }
                                        else
                                        {
                                            <option selected="selected" value="@productTypeProduct.Id"> @productTypeProduct.TypeName </option>
                                        }
                                    }

                                </select>
                                Size: @cartItem.SizeType
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="dongia">
                            <i class="fa-solid fa-dong-sign"></i>
                            <div>@($"{cartItem.TypeProduct.Product.Price:#,###}")</div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <div class="dc-soluong">
                                <button class="decrement-soluong">-</button>
                                <input class="soluong" type="number" value="@cartItem.Quantity" id="quantity-1">
                                <button class="increment-soluong">+</button>
                            </div>
                            <div class="soluong-con-lai" id="remaining-quantity-1">Còn 
                                <span class="max-quantity">
                                    @cartItem.TypeProduct.Sizes.FirstOrDefault(c => c.SizeType == cartItem.SizeType).Quantity
                                </span>sản phẩm
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="sotien-phaitra">
                            <div class="dongia">
                                <i class="fa-solid fa-dong-sign fa-bounce"></i>
                                <div id="sotientra">@($"{total:#,###}")</div>
                            </div>
                        </div>
                    </td>

                    <td class="o-xoasanpham">
                        <div>
                            <a asp-action="RemoveCart" asp-route-id="@cartItem.Id">
                                <button class="xoa">Xóa</button>
                            </a>

                            <div class="timsanpham">
                                <a asp-controller="Search" asp-action="Index" asp-route-search="@cartItem.TypeProduct.Product.ProductName.Substring(0,7)" style="text-decoration: none">
                                    <div class="sanpham-tuongtu">Tìm sản phẩm tương tự</div>
                                    <div>
                                        <i class="fa-solid fa-caret-down"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </td>
                </tr>
            }
            <tr>
                <td colspan="5" class="footer-table">
                    <div class="footer-table1">
                        <img src=".\imgs\freeship.png">
                        <div id="text-ship">Giảm ₫30.000 phí vận chuyển đơn tối thiểu ₫0 </div>
                        @*TODO voucher ne cac ban*@
                        <div>
                            <span class="learn-more" data-popup="popup-1" onclick="Erorr()">Tìm hiểu thêm</span>
                            <div class="popup hidden" id="popup-1">
                                <div id="popup-content">
                                    <div id="popup-content1">
                                        <h3>Khuyến mãi vận chuyển</h3>
                                    </div>
                                    <div id="popup-content2">@seller.SellerName</div>
                                    <table>
                                        <thead>
                                        <tr>
                                            <th>Đơn hàng tối thiểu</th>
                                            <th>Ưu đãi</th>
                                            <th>Phương thức vận chuyển</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td>₫0</td>
                                            <td>₫30.000</td>
                                            <td>Nhanh</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="5" style="background-color: #f5f5f5 !important;height: 50px"></td>
            </tr>
        }

        </tbody>
    }
    else  //Gio Hang rong
    {
        <tr>
            <td colspan="6" style="height: 290px;font-size: larger;font-style: oblique;">
                <div>Giỏ Hàng Của Bạn Đang Trống !</div>
                <a asp-controller="Home" asp-action="Index" >
                    <button style="background-color: #EE4D2D ; border: none;padding: 7px; box-shadow: 5px 5px 10px 0 rgba(0, 0, 0, 0.5);">
                        <div style="color: white  ">Mua Hàng</div>
                    </button>
                </a>
            </td>
        </tr>
    }

</table>

<section class="footer">
    <div class="voucher">
        <button onclick="Erorr()">Chọn hoặc nhập mã</button>
        <div class="text-shopeevoucher">Shopee Voucher</div>
        <div class="logovoucher">
            <img src="/imgs/logovoucher.png">
        </div>
    </div>
    <div class="shopee-xu">
        <div id="sotien">
            <div>-₫0</div>
        </div>
        <div id="shopee-xu1">
            <div class="div-logodongtien">
                <img src="/imgs/logodongtien.png">
            </div>
            <div id="text-shopeexu">Shopee Xu</div>
            <div id="text-xu">Bạn chưa có Shopee Xu</div>
            <div class="div-logodauhoi">
                <i class="fa-regular fa-circle-question fa-bounce"></i>
            </div>
        </div>
    </div>
    <div class="footer-mua">
        <div class="div1">
            <div class="div1-1" id="selectAllProducts">
                <input type="checkbox" id="selectAllCheckbox1">
            </div>
            <button class="button1-1">Chọn tất cả (@Model.CartItems.Sum(item => 1))</button>
            <button class="button1-2" onclick="confirmClearCart()">Xóa Tất Cả</button>
            <button class="button1-3" onclick="Erorr()">Lưu vào mục Đã thích</button>
        </div>

        <div class="div2">
            <div class="div2-1">
                <div class="div2-1-1" id="selected-products">Tổng thanh toán(0 sản phẩm): </div>
                <div class="div2-1-2" id="total-price">
                    <i class="fa-solid fa-dong-sign fa-bounce"></i>
                    0.00
                </div>
            </div>
            <a asp-controller="Checkout" asp-action="Index" >
                <button class="button-muahang" id="checkoutButton">
                    <div>Mua Hàng</div>
                </button>
            </a>
        </div>
    </div>
</section>
</div>
</section>

<script>
const loaimau = document.getElementById("loaimau");
loaimau.addEventListener('change',changeProductId)
function changeProductId(e) {
    const newTypeId = e.target.value;
    fetch(window.location.href+`?cartItemId={}`)
}

function Erorr(){
    confirm("Xin lỗi bạn! Tôi chưa thêm chức năng cho sự kiện này...");
}

function confirmClearCart() {
        // hộp thoại xác nhận
        var isConfirmed = confirm("Bạn có chắc chắn muốn Xóa Tất Cả sản phẩm trong giỏ hàng?");
        // Nếu người dùng đồng ý
        if (isConfirmed) {
            window.location.href = "@Url.Action("ClearCart", "Cart", new
                                    {
                                        cartId = @Model.Id
                                    })";
        }
    }
</script>